# ModSecurity Configuration
# Web Application Firewall rules for ecommerce platform

# ==========================================================================
# ModSecurity Core Configuration
# ==========================================================================

# Enable ModSecurity
SecRuleEngine On

# Request body access
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body access
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# File uploads
SecTmpDir /tmp/
SecDataDir /tmp/
SecUploadDir /tmp/uploads/
SecUploadKeepFiles Off

# Debug logging
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# ==========================================================================
# OWASP ModSecurity Core Rule Set (CRS)
# ==========================================================================

# Include OWASP CRS base configuration
Include /etc/modsecurity/crs/crs-setup.conf

# Include OWASP CRS rules
Include /etc/modsecurity/crs/rules/*.conf

# ==========================================================================
# Custom Rules for Ecommerce Platform
# ==========================================================================

# Rule ID range: 100000-199999 (custom rules)

# --------------------------------------------------------------------------
# SQL Injection Protection
# --------------------------------------------------------------------------

SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY "@detectSQLi" \
    "id:100001,\
    phase:2,\
    block,\
    capture,\
    t:none,t:urlDecodeUni,t:lowercase,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}'"

# --------------------------------------------------------------------------
# XSS Protection
# --------------------------------------------------------------------------

SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY "@detectXSS" \
    "id:100002,\
    phase:2,\
    block,\
    capture,\
    t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}'"

# --------------------------------------------------------------------------
# Sensitive Data Leakage Prevention
# --------------------------------------------------------------------------

# Block credit card numbers in responses
SecRule RESPONSE_BODY "@rx (?:\d[ -]*?){13,16}" \
    "id:100003,\
    phase:4,\
    block,\
    capture,\
    msg:'Credit Card Number Detected in Response',\
    logdata:'Potential CC: %{TX.0}',\
    tag:'application-multi',\
    tag:'pci/6.5.6',\
    tag:'OWASP_AppSensor/RE3',\
    severity:'CRITICAL'"

# Block SSN patterns
SecRule RESPONSE_BODY "@rx \b(?!000|666|9\d{2})\d{3}-(?!00)\d{2}-(?!0000)\d{4}\b" \
    "id:100004,\
    phase:4,\
    block,\
    msg:'SSN Detected in Response',\
    tag:'application-multi',\
    severity:'CRITICAL'"

# --------------------------------------------------------------------------
# Session Fixation Prevention
# --------------------------------------------------------------------------

SecRule REQUEST_COOKIES "!@rx ^JSESSIONID=[A-Z0-9]{32}$" \
    "id:100005,\
    phase:2,\
    pass,\
    nolog,\
    tag:'application-multi',\
    tag:'attack-fixation',\
    chain"
    SecRule REQUEST_URI "@streq /login" \
        "t:none,\
        msg:'Potential Session Fixation Attack',\
        logdata:'Cookie: %{MATCHED_VAR}'"

# --------------------------------------------------------------------------
# Rate Limiting
# --------------------------------------------------------------------------

# Limit login attempts (10 per minute per IP)
SecAction "id:100006,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR}"

SecRule REQUEST_URI "@streq /api/login" \
    "id:100007,\
    phase:2,\
    pass,\
    setvar:ip.login_attempts=+1,\
    expirevar:ip.login_attempts=60,\
    nolog"

SecRule IP:LOGIN_ATTEMPTS "@gt 10" \
    "id:100008,\
    phase:2,\
    block,\
    msg:'Too Many Login Attempts',\
    logdata:'Login attempts: %{ip.login_attempts}',\
    tag:'attack-bruteforce',\
    severity:'WARNING'"

# Limit checkout attempts (20 per minute per IP)
SecRule REQUEST_URI "@beginsWith /api/checkout" \
    "id:100009,\
    phase:2,\
    pass,\
    setvar:ip.checkout_attempts=+1,\
    expirevar:ip.checkout_attempts=60,\
    nolog"

SecRule IP:CHECKOUT_ATTEMPTS "@gt 20" \
    "id:100010,\
    phase:2,\
    block,\
    msg:'Too Many Checkout Attempts',\
    tag:'attack-dos',\
    severity:'WARNING'"

# --------------------------------------------------------------------------
# Payment Processing Protection
# --------------------------------------------------------------------------

# Ensure payment requests use POST only
SecRule REQUEST_URI "@beginsWith /api/payment" \
    "id:100011,\
    phase:1,\
    chain,\
    deny,\
    msg:'Payment requests must use POST method'"
    SecRule REQUEST_METHOD "!@streq POST"

# Block payment requests without CSRF token
SecRule REQUEST_URI "@beginsWith /api/payment" \
    "id:100012,\
    phase:2,\
    chain,\
    deny,\
    msg:'Missing CSRF token in payment request'"
    SecRule REQUEST_HEADERS:X-CSRF-Token "@eq ''"

# --------------------------------------------------------------------------
# File Upload Protection
# --------------------------------------------------------------------------

# Restrict file upload extensions
SecRule FILES_NAMES "@rx \.(?:exe|dll|bat|cmd|sh|jar|war|php|py|rb|pl)$" \
    "id:100013,\
    phase:2,\
    block,\
    msg:'Dangerous File Upload Detected',\
    logdata:'Filename: %{MATCHED_VAR}',\
    tag:'attack-fileupload',\
    severity:'CRITICAL'"

# Limit file upload size to 10MB
SecRule FILES_SIZES "@gt 10485760" \
    "id:100014,\
    phase:2,\
    block,\
    msg:'File Upload Too Large',\
    logdata:'Size: %{MATCHED_VAR} bytes',\
    severity:'WARNING'"

# --------------------------------------------------------------------------
# Geographic Restrictions (Optional)
# --------------------------------------------------------------------------

# Block requests from high-risk countries (example)
# SecRule REMOTE_ADDR "@geoLookup" \
#     "id:100015,\
#     phase:1,\
#     chain,\
#     deny,\
#     msg:'Request from Blocked Country'"
#     SecRule GEO:COUNTRY_CODE "@within CN RU KP"

# --------------------------------------------------------------------------
# Security Headers Enforcement
# --------------------------------------------------------------------------

# Add security headers to all responses
SecRule RESPONSE_HEADERS:!Content-Security-Policy "@rx ^$" \
    "id:100016,\
    phase:3,\
    pass,\
    nolog,\
    setenv:CSP=1"

Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';" env=CSP

Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "DENY"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# --------------------------------------------------------------------------
# Anomaly Scoring Threshold
# --------------------------------------------------------------------------

# Set anomaly score thresholds
SecAction "id:100100,\
    phase:1,\
    nolog,\
    pass,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# Block if anomaly score exceeds threshold
SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_threshold}" \
    "id:100101,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Inbound Anomaly Score Exceeded',\
    logdata:'Total Inbound Score: %{TX.ANOMALY_SCORE}'"

SecRule TX:OUTBOUND_ANOMALY_SCORE "@ge %{tx.outbound_anomaly_score_threshold}" \
    "id:100102,\
    phase:4,\
    deny,\
    status:403,\
    msg:'Outbound Anomaly Score Exceeded',\
    logdata:'Total Outbound Score: %{TX.OUTBOUND_ANOMALY_SCORE}'"
